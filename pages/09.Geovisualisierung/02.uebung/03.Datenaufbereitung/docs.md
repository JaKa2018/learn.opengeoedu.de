# Aufbereitung der Daten
## Resampling
Starten Sie SNAP und öffnen Sie über File --> Open Product die .xml-Datei MTD_MSIL1C, die sich innerhalb des Ordners der ersten heruntergeladenen Sentinel-2 Datei befindet. Rechtsklicken Sie auf den Dateinamen im Product Explorer und wählen Sie Open RGB Image Window. Belassen Sie die Default-Einstellungen, klicken Sie auf OK und untersuchen Sie das erzeugte Echtfarbbild. Per Klick auf das Handsymbol in der oberen Menüleiste aktivieren Sie das Panning und können sich anschließend mit der Maus im Bild bewegen. Im Colour Manipulation Feld unten links können Sie die Darstellung der drei Kanäle anpassen, indem Sie die Position der Schieberegler verändern. 

Da die Kanäle von Sentinel-2 in unterschiedlichen Auflösungen vorliegen (10 m, 20 m, 60 m) ist vor der weiteren Verarbeitung ein Resampling nötig. Wählen Sie unter Raster --> Geometric Operations --> Resampling. Passen Sie Ausgabe-Pfad und –Dateinamen an (aktivieren Sie dazu Save as BEAM DIMAP), wählen Sie in den Resampling Parameters By reference band from source product, wählen Sie B2 und klicken Sie auf Run. Je nach Rechnerleistung kann dieser Prozess einige Minuten in Anspruch nehmen. Wiederholen Sie den Vorgang für die zweite Sentinel-2 Aufnahme. Achten Sie darauf, dass im Resampling-Schritt der richtige Datensatz als Source Product angegeben ist. 

## Subset
Um die Rechenzeit der weiteren Schritte nicht unnötig in die Höhe zu treiben, können die Datensätze bereits grob auf das Untersuchungsgebiet zurechtgeschnitten werden. Erstellen Sie dazu eine beliebige RGB-Ansicht (Rechtsklick, Open RGB Image Window) des ersten resampled Sentinel-2 Datensatzes und zoomen Sie auf die Waldfläche des westlichen Taunus. Zur Orientierung sollten Sie am linken Bildschirmrand den Rhein und am rechten Rand die in Nord-Süd Richtung verlaufende Autobahn A3 erkennen können (siehe Abbildung). Wählen Sie Raster --> Subset, entfernen Sie im Reiter Band Subset die Häkchen bei allen Kanälen, die keine Reflectance in band x beinhalten und bestätigen Sie. Wiederholen Sie den Vorgang für die andere resampled Sentinel 2 Szene. 

![AOI](/pages/09.Geovisualisierung/AOI_SNAP_Subset.png)

*Räumliches Subset des Untersuchungsgebiets im Taunus. Zu erkennen ist der Lauf des Rheins zwischen Mainz und Wiesbaden.*

## Collocation
Um die beiden bearbeiteten Sentinel-2 Datensätze leichter miteinander vergleichen zu können, werden Sie in einem gemeinsamen Datensatz zusammengeführt. Wählen Sie Raster --> Geometric Operations --> Collocation, wählen Sie die beiden Subset-Datensätze als Master und Slave aus und vergeben Sie einen aussagekräftigen Ausgabe-Dateinamen. Vergeben Sie unter Renaming of Source Products Components das jeweilige Datum als Anhang an die Bandnamen, um diese später unterscheiden zu können (z.B. ${ORIGINAL_NAME}_20170823) und klicken Sie auf Run. 

## Reprojizieren
Die Daten liegen ursprünglich im Geographischen Koordinatensystem (GCS WGS 84) in Grad und Minuten vor. Um eine Kartenprojektion mit Meterangaben zu erhalten, werden die Sentinel-Daten in ein projiziertes Koordinatensystem transformiert. Wählen Sie Raster --> Geometric Operations --> Reprojection. Wählen Sie die eben erstelle Datei als Eingabedatensatz und vergeben Sie einen geeigneten Namen für die Ausgabedatei. Unter Reprojection Parameters wählen Sie Predefined CRS und geben Sie unter Select den EPSG-Code 25832 ein (= ETRS89/UTM Zone 32N). Wählen Sie das Ergebniskoordinatensystem aus und bestätigen Sie mit Ok und Run. 

## QGIS-OSM-Aufbereitung
In diesem Schritt wird ein Vektordatensatz so aufbereitet, dass er nur die Waldflächen Hessens beinhaltet. Damit wird der Sentinel-2 Datensatz im Anschluss maskiert, sodass sich die Analyse ausschließlich auf die Waldfläche konzentriert, wodurch Fehlklassifikationen vermieden werden können.

## Subsetting & Reprojektion
Starten Sie QGIS und klicken Sie auf Vektorlayer hinzufügen in der linken Randleiste (alternativ: Layer --> Layer hinzufügen --> Vektorlayer hinzufügen). Wählen Sie das landuse-Shapefile des heruntergeladenen OpenStreetMap Datensatzes aus und bestätigen Sie. Rechtsklicken Sie auf den Layer im Layerfenster und öffnen Sie die Attributtabelle. Diese beinhaltet zeilenweise alle Objekte und spaltenweise alle Objektinformationen des jeweiligen Layers. Klicken Sie auf Objekte über Ausdruck wählen und erstellen Sie den Ausdruck “fclass“ = ‘forest‘. Bestätigen Sie mit Klick auf Auswahl. Rechtsklicken Sie auf den Layer im Layerfenster und wählen Sie Speichern als. Vergeben Sie einen Dateinamen, setzen Sie ein Häkchen bei Nur gewählte Objekte speichern und bestätigen Sie. Fügen Sie über Verarbeitung --> Werkzeugkiste die Werkzeugbox hinzu und suchen Sie nach dem Tool Layer reprojizieren. Wählen Sie den eben erstellten Datensatz als Eingabelayer, als Ziel-KBS (Koordinatenbezugsystem) das zum EPSG-Code 25832 zugehörige Koordinatensystem, vergeben Sie einen geeigneten Ausgabedateinamen und bestätigen Sie. 

## Puffern & Löschen kleiner Objekte
Um Ungenauigkeiten an den Waldrändern auszuschließen und sicher zu stellen, dass der Vektordatensatz nur Waldflächen enthält, werden die Objekte an den Rändern um 20 Meter reduziert. Wählen Sie dazu Vektor --> Geoverarbeitungswerkzeuge --> Puffer festen Abstands. Wählen Sie den reprojizierten Layer als Eingabelayer und geben Sie bei Entfernung -20 ein. Bestätigen Sie mit Run. Durch diesen Prozess können kleine Polygonsplitter übrig bleiben, die entfernt werden müssen. Verwenden Sie dazu zunächst das Tool Vektor --> Geometrie-Werkzeuge --> Mehr- zu einteilig. Damit werden Polygone, die durch das Puffern räumlich aufgeteilt wurden, aber noch als gemeinsames Objekt gelten, in Einzelobjekte aufgeteilt. Wählen Sie den gepufferten Layer als Eingabe und klicken Sie auf Run. Fügen Sie dem neu erstellten Layer über Vektor --> Geometrie-Werkzeuge --> Geometriespalte hinzufügen Informationen über die Objektgröße hinzu. Öffnen Sie die Attributtabelle des wiederum neu erstellten Layers, klicken Sie auf Objekte über Ausdruck wählen und geben Sie den Ausdruck „area“ < 1000 ein. Damit werden alle Objekte, die kleiner als 1000 m² sind, ausgewählt. Klicken Sie in der Attributtabelle anschließend auf Bearbeitungsmodus umschalten (Stift-Symbol) und anschließend auf Gewählte Objekte löschen (Mülleimersymbol). Klicken Sie auf Änderungen speichern und verlassen Sie den Bearbeitungsmodus, indem Sie erneut auf das entsprechende Symbol klicken. Schließen Sie anschließend die Attributtabelle, Rechtsklicken Sie auf den aktuellen Layer und wählen Speichern als. Speichern Sie die finale Waldmaske unter einem aussagekräftigen Dateinamen.

## Maskierung der Waldflächen
Kehren Sie zurück zu SNAP, wählen Sie mit einem Linksklick die zusammengesetzte Sentinel-2 Datei aus und klicken Sie File --> Import --> Vector Data --> ESRI Shapefile. Navigieren Sie zur in QGIS zuletzt erstellten Waldmaske und bestätigen Sie. Klicken Sie im folgenden Dialog (Import Geometry) auf No. Wählen Sie Raster --> Masks --> Land/Sea Mask. Vergeben Sie einen Ausgabedateinamen. In den Processing Parameters entfernen Sie den Haken von Use SRTM 3sec und wählen Sie Use Vector as Mask. Im Dropdown-Menü wählen Sie den importierten OSM-Layer als Maske aus und bestätigen mit Run. Die neue Datei enthält nur Sentinel-2 Daten für die im OSM-Datensatz als Wald klassifizierten Flächen. Erstellen Sie eine RGB-Ansicht (Rechtsklick --> Open RGB Image Window, für ein Echtfarbbild wählen Sie jeweils die Bänder Red: B4, Green: B3 und Blue: B2) oder öffnen Sie einen einzelnen Kanal, indem Sie auf das + Zeichen neben dem Layer klicken, anschließend auf Bands und dort auf ein beliebiges Band doppelklicken. Im Layer Manager (View --> Tool Windows --> Layer Manager) können Sie die Vektordaten in der Ansicht an- und ausschalten. Mehrere geöffnete Ansichten können Sie per Klick auf Tile vertically oder Tile horizontally ( BILD ) geordnet nebeneinander anzeigen und so miteinander vergleichen.
